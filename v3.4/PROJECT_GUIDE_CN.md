# CXN0102 投影仪控制器工程说明

## 📋 项目概述

本项目是一个基于 **ESP32-C3 SuperMini** 开发的低成本投影仪控制器，用于控制 **CXN0102** 激光投影仪模块。通过这个控制器，可以用约20美元的成本获得720p分辨率的激光投影仪。

### 项目信息
- **当前版本**: v3.4
- **作者**: vx:samzhangxian
- **GitHub仓库**: https://github.com/old-Jerry/cxn0102projector_controller_esp32c3_supermini
- **开发框架**: Arduino (PlatformIO)

---

## 🔧 硬件配置

### 主控芯片
- **型号**: ESP32-C3 (ESP32-C3-DevKitM-1)
- **架构**: RISC-V 32位
- **特点**: 低功耗、支持WiFi和蓝牙

### 引脚定义

| 引脚 | 功能 | 说明 |
|------|------|------|
| GPIO8 | SDA | I2C数据线 |
| GPIO7 | SCL | I2C时钟线 |
| GPIO2 | BUTTON | 物理关机按钮（低电平触发）|
| GPIO10 | COM_REQ | 通信请求引脚 |

### 通信参数
- **I2C地址**: 0x77
- **I2C速度**: 标准速度（100kHz）
- **WiFi模式**: SoftAP（接入点模式）

---

## 🌐 WiFi配置

### 热点信息
- **SSID**: `CXN0102_Web_Controller`
- **密码**: `12345678`（必须≥8字符）
- **IP地址**: `192.168.4.1`
- **端口**: 80

### WiFi发射功率
支持12档功率调节，可在Web界面中设置：

| 功率值 | dBm值 | 功率 | 适用场景 |
|--------|-------|------|----------|
| 78 | 19.5 dBm | ≈90mW | 最强信号 |
| 76 | 19 dBm | ≈79mW | 强信号 |
| 74 | 18.5 dBm | ≈71mW | 较强信号 |
| 68 | 17 dBm | ≈50mW | 中等信号 |
| 60 | 15 dBm | ≈32mW | 标准信号 |
| 52 | 13 dBm | ≈20mW | 较低功耗 |
| 44 | 11 dBm | ≈12mW | 低功耗 |
| 34 | 8.5 dBm | ≈7mW | 默认值 |
| 28 | 7 dBm | ≈5mW | 超低功耗 |
| 20 | 5 dBm | ≈3mW | 极低功耗 |
| 8 | 2 dBm | ≈1.6mW | 最低功耗 |
| -4 | -1 dBm | ≈0.8mW | 最小功耗 |

---

## 🎮 功能说明

### 1. 基本控制功能

| 功能 | 命令代码 | 说明 |
|------|----------|------|
| 开始输入 | 0100 | 启动投影仪输入 |
| 停止输入 | 0200 | 停止投影仪输入 |
| 重启 | 0b0101 | 重启投影仪 |
| 关机 | 0b0100 | 关闭投影仪 |

### 2. 光轴调整

光轴调整用于校正投影图像的几何位置。

| 功能 | 命令代码 | 说明 |
|------|----------|------|
| 进入光轴调整 | 3200 | 进入光轴调整模式 |
| 光轴增加 | 3300 | 向上调整光轴 |
| 光轴减少 | 3400 | 向下调整光轴 |
| 退出（不保存）| 350100 | 退出调整模式，不保存 |
| 退出（保存）| 350101 | 退出调整模式，保存设置 |

**使用方法**:
1. 点击"进入/切换下一项"进入光轴调整模式
2. 使用"+"和"-"按钮调整光轴
3. 点击"退出（保存）"保存设置并退出

### 3. 双相位调整

双相位调整用于优化图像的相位对齐。

| 功能 | 命令代码 | 说明 |
|------|----------|------|
| 进入双相位调整 | 3600 | 进入双相位调整模式 |
| 双相位增加 | 3700 | 增加双相位值 |
| 双相位减少 | 3800 | 减少双相位值 |
| 退出（不保存）| 390100 | 退出调整模式，不保存 |
| 退出（保存）| 390101 | 退出调整模式，保存设置 |

### 4. 梯形校正

梯形校正用于修正投影角度造成的图像变形。

| 参数 | 范围 | 说明 |
|------|------|------|
| 水平调整 | -30 到 +30 | 水平梯形校正 |
| 垂直调整 | -20 到 +20 | 垂直梯形校正 |
| 翻转模式 | 0-3 | 0=无, 1=水平, 2=垂直, 3=双向 |

**I2C命令格式**:
```
0x26 0x09 [pan] [tilt] [flip] 0x64 0x00 0x00 0x00 0x00 0x00
```

### 5. 画质调整

支持多种画质参数的精细调整：

| 参数 | 范围 | I2C命令 | 映射范围 |
|------|------|---------|----------|
| 亮度 | 0-255 | 0x43 | -31 到 +31 |
| 对比度 | 0-255 | 0x45 | -15 到 +15 |
| 色调U | 0-255 | 0x47 | -15 到 +15 |
| 色调V | 0-255 | 0x47 | -15 到 +15 |
| 饱和度U | 0-255 | 0x49 | -15 到 +15 |
| 饱和度V | 0-255 | 0x49 | -15 到 +15 |
| 锐度 | 0-255 | 0x4F | 0 到 8 |

**色调和饱和度说明**:
- 新版本支持U/V分量独立调整，提供更精确的色彩控制
- 兼容旧版本的单值调整方式

### 6. 其他功能

| 功能 | 命令代码 | 说明 |
|------|----------|------|
| 翻转模式 | 4A | 切换图像翻转 |
| 测试图案开 | 5001 | 显示测试图案 |
| 测试图案关 | 5000 | 关闭测试图案 |
| 静音 | 6000 | 静音输出 |
| 取消静音 | 6001 | 恢复音频 |
| 色温减少 | 8000 | 降低色温 |
| 色温增加 | 8001 | 提高色温 |

### 7. 测试图案

支持多种测试图案用于调试和校准：

| 类型 | 值 | 说明 |
|------|-----|------|
| 停止 | 0 | 关闭测试图案 |
| 色条 | 1 | 显示彩色色条 |
| 网格 | 2 | 显示网格图案 |

---

## 💾 参数持久化

### EEPROM存储布局

| 地址 | 参数 | 类型 | 范围 | 说明 |
|------|------|------|------|------|
| 0 | pan | int8_t | [-30,30] | 水平梯形校正 |
| 1 | tilt | int8_t | [-20,20] | 垂直梯形校正 |
| 2 | flip | uint8_t | [0-3] | 翻转模式 |
| 3 | txPower | int8_t | 预设值 | WiFi发射功率 |
| 4 | lang | uint8_t | 0/1 | 语言(0=英文,1=中文)|
| 5 | brightness | uint8_t | [0,255] | 亮度 |
| 6 | contrast | uint8_t | [0,255] | 对比度 |
| 7 | hue | uint8_t | [0,255] | 色调（旧版）|
| 8 | saturation | uint8_t | [0,255] | 饱和度（旧版）|
| 9 | sharpness | uint8_t | [0,255] | 锐度 |
| 10 | hueU | uint8_t | [0,255] | 色调U分量 |
| 11 | hueV | uint8_t | [0,255] | 色调V分量 |
| 12 | satU | uint8_t | [0,255] | 饱和度U分量 |
| 13 | satV | uint8_t | [0,255] | 饱和度V分量 |
| 63 | magic | uint8_t | 0xA5 | 魔术字，用于验证 |

### 保存机制

1. **自动保存**: 修改参数后自动保存到EEPROM
2. **启动加载**: 设备启动时从EEPROM加载上次设置
3. **首次启动**: 如果魔术字不匹配，使用默认值并初始化EEPROM
4. **投影仪保存**: 可通过"保存所有参数"按钮将设置保存到投影仪内部

---

## 🌐 Web界面API

### 基础端点

| 端点 | 方法 | 参数 | 说明 |
|------|------|------|------|
| `/` | GET | - | 返回主控制页面 |
| `/ping` | GET | - | 连接状态检查 |

### 命令控制

| 端点 | 方法 | 参数 | 说明 |
|------|------|------|------|
| `/command` | GET | cmd (1-30) | 执行预定义命令 |
| `/custom_command` | GET | cmd (hex) | 发送自定义I2C命令 |

### 参数设置

| 端点 | 方法 | 参数 | 说明 |
|------|------|------|------|
| `/keystone` | GET | pan, tilt, flip | 设置梯形校正 |
| `/set_tx_power` | GET | power | 设置WiFi发射功率 |
| `/set_pq` | GET | brightness, contrast, hueU, hueV, satU, satV, sharpness | 设置画质参数 |
| `/set_settings` | GET | 任意参数 | 设置并保存参数 |
| `/set_lang` | GET | lang (en/zh) | 设置界面语言 |

### 参数获取

| 端点 | 方法 | 返回 | 说明 |
|------|------|------|------|
| `/get_settings` | GET | JSON | 获取所有保存的设置 |
| `/get_temperature` | GET | JSON | 获取温度信息 |
| `/get_device_info` | GET | JSON | 获取设备详细信息 |

### 系统操作

| 端点 | 方法 | 说明 |
|------|------|------|
| `/factory_reset` | GET | 恢复出厂设置 |
| `/save_all` | GET | 保存所有参数到投影仪 |
| `/clear_eeprom` | GET | 清空EEPROM |
| `/test_pattern` | GET | type (0-2) | 输出测试图案 |

---

## 🔌 物理按钮控制

### 关机按钮
- **引脚**: GPIO2
- **触发方式**: 低电平（按下）
- **功能**: 
  1. 发送停止输入命令 (0200)
  2. 延迟100ms
  3. 发送关机命令 (0b0100)
- **防抖**: 50ms延时检测

---

## 📊 设备信息

### 可获取的信息

| 信息类型 | 说明 |
|----------|------|
| 温度 | 当前温度、静音阈值、停止阈值 |
| 运行时间 | 设备累计运行时间（秒）|
| 版本信息 | 固件版本、参数版本、数据版本 |
| 生产批号 | 制造批次号 |
| 序列号 | 设备唯一序列号 |

### 温度监控
- **更新频率**: 每10秒
- **显示位置**: Web界面系统区域
- **数据格式**: JSON格式返回

---

## 🛠️ 开发环境

### PlatformIO配置

```ini
[env:esp32-c3-devkitm-1]
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino
lib_deps = 
  SPI
  Wire
  mathieucarbou/ESPAsyncWebServer@^3.3.21
board_build.flash_mode = dio

build_flags =
  -D ARDUINO_USB_MODE=1
  -D ARDUINO_USB_CDC_ON_BOOT=1
```

### 依赖库
- **WiFi**: ESP32 WiFi库
- **AsyncTCP**: 异步TCP通信
- **ESPAsyncWebServer**: 异步Web服务器
- **Wire**: I2C通信
- **EEPROM**: 参数持久化

---

## 📖 使用指南

### 1. 硬件连接

```
ESP32-C3          CXN0102模块
--------          -----------
GPIO8 (SDA)  -->  SDA
GPIO7 (SCL)  -->  SCL
GND          -->  GND
3.3V         -->  VCC
GPIO2        -->  按钮（另一端接GND）
```

### 2. 固件烧录

1. 安装PlatformIO
2. 克隆项目仓库
3. 连接ESP32-C3到电脑
4. 运行编译和上传命令：
   ```bash
   pio run --target upload
   ```

### 3. 首次使用

1. 给设备上电
2. 等待5秒（启动延时）
3. 连接WiFi热点 `CXN0102_Web_Controller`
4. 浏览器访问 `http://192.168.4.1`
5. 开始使用控制界面

### 4. 基本操作流程

**调整投影图像**:
1. 使用"梯形校正"调整图像形状
2. 使用"光轴调整"优化图像位置
3. 使用"画质调整"优化图像质量
4. 点击"保存所有参数"保存设置

**关机操作**:
- 方式1: Web界面点击"关机"按钮
- 方式2: 按下物理按钮（GPIO2）

---

## 🔧 高级功能

### 自定义I2C命令

Web界面提供自定义命令输入框，支持发送任意十六进制I2C命令。

**格式要求**:
- 必须是偶数长度
- 只能包含0-9, a-f, A-F字符
- 最大长度50字符

**示例**:
- `0b0100` - 关机命令
- `0b0101` - 重启命令
- `0100` - 开始输入

### 参数映射

Web界面的0-255值会自动映射到投影仪的实际参数范围：

```cpp
// 亮度映射
brightness (0-255) → (-31 到 +31)

// 对比度映射
contrast (0-255) → (-15 到 +15)

// 色调/饱和度映射
hue/sat (0-255) → (-15 到 +15)

// 锐度映射
sharpness (0-255) → (0 到 8)
```

---

## 🐛 故障排除

### 常见问题

**1. 无法连接WiFi热点**
- 检查设备是否正常上电
- 等待5秒让设备完全启动
- 确认SSID和密码正确

**2. Web界面无法访问**
- 确认已连接到正确的WiFi热点
- 检查浏览器地址是否为 `http://192.168.4.1`
- 尝试刷新页面

**3. I2C命令无响应**
- 检查I2C接线是否正确
- 确认CXN0102模块已上电
- 查看串口调试信息

**4. 参数未保存**
- 确保EEPROM已正确初始化
- 检查魔术字是否为0xA5
- 尝试恢复出厂设置

### 调试信息

设备通过串口（9600波特率）输出调试信息：

```
[EEPROM] Settings saved.
[EEPROM] Loaded: pan=0 tilt=0 flip=0 txPower=34 lang=0 ...
[PQ] Set Hue U/V: 5/3, I2C error=0
Keystone and Flip command sent successfully.
```

---

## 📝 技术细节

### I2C通信协议

**写命令格式**:
```
[设备地址] [命令字节] [参数1] [参数2] ... [参数N]
```

**读命令格式**:
```
[设备地址] [命令字节] [参数]
[设备地址] [读取N字节]
```

### Web服务器架构

- **异步处理**: 使用ESPAsyncWebServer实现非阻塞HTTP服务
- **状态指示**: 每秒ping检查连接状态
- **实时更新**: 温度每10秒更新一次
- **参数同步**: 页面加载时自动获取保存的参数

### 内存管理

- **EEPROM大小**: 64字节
- **参数压缩**: 使用int8_t和uint8_t节省空间
- **魔术字验证**: 使用0xA5验证数据有效性

---

## 🔄 版本历史

### v3.4 (当前版本)
- 新增U/V分量独立调整
- 改进画质调整精度
- 优化Web界面响应速度
- 增强错误处理机制

### v3.3
- 添加多语言支持
- 优化WiFi功率控制
- 改进参数持久化

### v3.2
- 添加测试图案功能
- 优化I2C通信稳定性
- 改进温度监控

---

## 📄 许可证

本项目遵循开源许可证，具体请参考项目仓库。

---

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个项目。

---

## 📧 联系方式

- **作者**: vx:samzhangxian
- **GitHub**: https://github.com/old-Jerry/cxn0102projector_controller_esp32c3_supermini

---

## ⚠️ 注意事项

1. **电源**: 确保使用稳定的3.3V电源
2. **接线**: I2C接线要短且可靠
3. **散热**: 长时间使用注意散热
4. **安全**: 激光投影仪避免直视镜头
5. **备份**: 重要设置建议定期备份

---

## 📚 参考资料

- [ESP32-C3 技术参考手册](https://www.espressif.com/sites/default/files/documentation/esp32-c3_technical_reference_en.pdf)
- [CXN0102 固件规格说明](CXN0102_3AA_FWSpecification_v151a_E.pdf)
- [PlatformIO 文档](https://docs.platformio.org/)
- [Arduino ESP32 文档](https://docs.espressif.com/projects/arduino-esp32/en/latest/)

---

**最后更新**: 2026年1月14日
